(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-5d5989e6"],{"1cb3":function(t,e,n){"use strict";n.d(e,"d",(function(){return a})),n.d(e,"b",(function(){return o})),n.d(e,"a",(function(){return s})),n.d(e,"c",(function(){return l}));n("99af");var i=n("b775");function a(t,e){return Object(i["a"])({url:"pipeline/build/list",method:"get",params:{pipeline_id:t,last_build_number:e}})}function o(t){return Object(i["a"])({url:"pipeline/build/".concat(t),method:"get"})}function s(t,e){return Object(i["a"])({url:"pipeline/build",method:"post",data:{pipeline_id:parseInt(t),params:e}})}function l(t,e){return Object(i["a"])({url:"pipeline/build/log/".concat(t).concat(e?"/sse":""),method:"get"})}},"69e8":function(t,e,n){},8713:function(t,e,n){"use strict";var i=n("69e8"),a=n.n(i);a.a},"9a6a":function(t,e,n){"use strict";n.r(e);var i=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",[n("clusterbar",{attrs:{titleName:t.titleName,titleLink:["pipeline","pipelineBuilds"]}}),n("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"dashboard-container detail-dashboard dashboard-container-build-detail",staticStyle:{"margin-left":"20px","margin-right":"20px"},style:{height:t.maxHeight+"px"},attrs:{"max-height":t.maxHeight}},[n("div",{staticStyle:{padding:"5px 0px 0px"}},[n("el-form",{staticClass:"pod-item",staticStyle:{margin:"3px 0px 10px 0px",border:"1px solid #EBEEF5","box-shadow":"none",padding:"5px 20px"},attrs:{"label-position":"left",inline:"","label-width":"80px"}},[n("el-form-item",{attrs:{label:"构建号"}},[n("span",{style:{color:t.statusColorMap[t.build.pipeline_run.status],"font-size":"16px"}},[n("i",{class:t.statusIconMap[t.build.pipeline_run.status]}),t._v(" #"+t._s(t.build.pipeline_run.build_number)+" ")])]),n("el-form-item",{attrs:{label:"构建时间"}},[n("span",[t._v(t._s(t.$dateFormat(t.build.pipeline_run.create_time)))])]),n("el-form-item",{attrs:{label:"CommitId"}},[n("span",[t._v(t._s(t.getBuildCommitId()))])]),n("el-form-item",{attrs:{label:"构建人"}},[n("span",{},[t._v(t._s(t.build.pipeline_run.operator))])]),n("el-form-item",{attrs:{label:"构建分支"}},[n("span",[t._v(t._s(t.build.pipeline_run.env?t.build.pipeline_run.env["PIPELINE_CODE_BRANCH"]:""))])]),n("el-form-item",{attrs:{label:"Comment"}},[n("span",[t._v(t._s(t.getBuildCommitComment()))])])],1)],1),n("div",[n("div",{staticClass:"pod-item",staticStyle:{margin:"0px",border:"1px solid #EBEEF5","box-shadow":"none","font-size":"14px",padding:"0px"},style:{height:t.maxHeight-80+"px"},attrs:{"label-position":"left",inline:"","label-width":"80px"}},[n("el-container",{staticStyle:{height:"100%"}},[n("el-aside",{staticStyle:{"border-right":"1px solid #EBEEF5",height:"100%",padding:"10px 20px","line-height":"25px",color:"#606266"},attrs:{width:"240px",hight:"100%"}},t._l(t.build.stages_run,(function(e){return n("div",{key:e.id,style:{color:t.statusColorMap[e.status]}},[n("div",{staticClass:"click-main-content",on:{click:function(n){return t.clickStage(e)}}},[t._v(" "+t._s(e.name)+" ")]),t._l(e.jobs,(function(i){return n("div",{key:i.id,staticClass:"click-main-content",staticStyle:{"margin-left":"15px"},on:{click:function(n){return t.clickStage(e,i)}}},[n("i",{class:t.statusIconMap[i.status]}),t._v(" "+t._s(i.name)+" ")])}))],2)})),0),"stage"==t.mainContent.type?n("el-main",{staticStyle:{padding:"3px 0px"}},[n("el-form",{staticClass:"pod-item",staticStyle:{margin:"3px 0px 0px 0px",border:"0px solid #EBEEF5","box-shadow":"none",padding:"5px 20px"},attrs:{"label-position":"left",inline:"","label-width":"80px"}},[n("el-form-item",{attrs:{label:"阶段"}},[n("span",{style:{color:t.statusColorMap[t.mainContent.mainStage.status],"font-size":"14px"}},[n("i",{class:t.statusIconMap[t.mainContent.mainStage.status]}),t._v(" "+t._s(t.mainContent.mainStage.name)+" ")])]),n("el-form-item",{attrs:{label:"执行时间"}},[n("span",[t._v(t._s(t.$dateFormat(t.mainContent.mainStage.exec_time)))])]),"ok"==t.mainContent.mainStage.status||"error"==t.mainContent.mainStage.status?n("el-form-item",{attrs:{label:"完成时间"}},[n("span",[t._v(t._s(t.$dateFormat(t.mainContent.mainStage.update_time)))])]):t._e()],1),n("div",{staticClass:"stage-params",staticStyle:{"margin-left":"20px","margin-right":"20px",color:"#99a9bf"}},[n("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"table-fix",staticStyle:{width:"100%"},attrs:{data:t.mainStageEnvs,"tooltip-effect":"dark","max-height":t.maxHeight-150,"cell-style":t.cellStyle,"default-sort":{prop:"name"},"row-key":"name"}},[n("el-table-column",{attrs:{prop:"name",label:"流水线环境参数","show-overflow-tooltip":""}}),n("el-table-column",{attrs:{prop:"value",label:"参数值"}})],1)],1)],1):t._e(),"job"==t.mainContent.type?n("el-main",{staticStyle:{padding:"3px 0px"}},[n("el-form",{staticClass:"pod-item",staticStyle:{margin:"3px 0px 0px 0px",border:"0px solid #EBEEF5","box-shadow":"none",padding:"5px 20px"},attrs:{"label-position":"left",inline:"","label-width":"80px"}},[n("el-form-item",{attrs:{label:"任务"}},[n("span",{style:{color:t.statusColorMap[t.mainContent.mainJob.status],"font-size":"14px"}},[n("i",{class:t.statusIconMap[t.mainContent.mainJob.status]}),t._v(" "+t._s(t.mainContent.mainJob.name)+" ")])]),n("el-form-item",{attrs:{label:"执行时间"}},[n("span",[t._v(t._s(t.$dateFormat(t.mainContent.mainStage.exec_time)))])]),"ok"==t.mainContent.mainJob.status||"error"==t.mainContent.mainJob.status?n("el-form-item",{attrs:{label:"完成时间"}},[n("span",[t._v(t._s(t.$dateFormat(t.mainContent.mainJob.update_time)))])]):t._e()],1),n("div",{staticStyle:{overflow:"scroll",color:"#C0C4CC",margin:"0px 10px",padding:"10px 15px","line-height":"17px","white-space":"pre-wrap","background-color":"#303133"},style:{height:t.maxHeight-130+"px"},attrs:{id:"jobLogDiv"}},[n("div",[t._v(t._s("wait"==t.mainContent.mainJob.status?"待执行...":t.mainContent.jobLog?t.mainContent.jobLog:""))]),"doing"!=t.mainContent.mainJob.status&&"wait"!=t.mainContent.mainJob.status?n("div",[t._v("执行结果："),n("br"),t._v(t._s(t.mainContent.mainJob.result))]):t._e(),"doing"==t.mainContent.mainJob.status?n("div",[n("i",{staticClass:"el-icon-loading"})]):t._e()])],1):t._e()],1)],1)])])],1)},a=[],o=(n("c975"),n("b0c0"),n("b85c")),s=n("61b2"),l=n("1cb3"),r={name:"PipelineBuildDetail",components:{Clusterbar:s["a"]},data:function(){return{titleName:[],search_name:"",users:[],cellStyle:{border:0,padding:"6px 0"},maxHeight:window.innerHeight-130,loading:!0,build:{pipeline_run:{}},buildSSE:null,statusIconMap:{ok:"el-icon-success",error:"el-icon-error",wait:"el-icon-remove",doing:"el-icon-refresh refresh-rotate"},statusColorMap:{ok:"#67c23a",error:"#DC143C",doing:"#E6A23C"},pipelines:[{name:"PIPELINE_CODE_COMMIT_ID",value:"https://github.com/openspacee/osp"}],mainContent:{type:"",mainStage:{},mainJob:{},jobLog:""},jobLogSSE:null,jobLogId:"",runningStatus:["doing","wait"],scrollToBottom:!0}},created:function(){this.getBuild()},destroyed:function(){this.buildSSE&&this.buildSSE.close(),this.jobLogSSE&&this.jobLogSSE.close()},mounted:function(){var t=this;window.onresize=function(){return function(){var e=window.innerHeight-130;t.maxHeight=e}()}},computed:{buildId:function(){return this.$route.params.buildId},mainStageEnvs:function(){if(this.mainContent.mainStage.env){var t=[];for(var e in this.mainContent.mainStage.env)t.push({name:e,value:this.mainContent.mainStage.env[e]});return t}return[]}},methods:{getBuild:function(){var t=this;this.loading=!0,Object(l["b"])(this.buildId).then((function(e){t.build=e.data,t.titleName=["流水线",t.build.pipeline.name,"#"+t.build.pipeline_run.build_number],t.getMainContent(),t.runningStatus.indexOf(t.build.pipeline_run.status)>=0&&t.fetchBuildSSE(),t.loading=!1})).catch((function(){t.loading=!1}))},getMainContent:function(){var t,e=Object(o["a"])(this.build.stages_run);try{for(e.s();!(t=e.n()).done;){var n=t.value;if("ok"!=n.status){var i,a=Object(o["a"])(n.jobs);try{for(a.s();!(i=a.n()).done;){var s=i.value;if("ok"!=s.status)return this.mainContent={type:"job",mainStage:n,mainJob:s,jobLog:""},void this.getJobLog()}}catch(l){a.e(l)}finally{a.f()}}}}catch(l){e.e(l)}finally{e.f()}this.mainContent={type:"job",mainStage:this.build.stages_run[0],mainJob:this.build.mainStage.jobs[0],jobLog:""},this.getJobLog()},fetchBuildSSE:function(){var t=this,e="/api/v1/pipeline/build/".concat(this.buildId,"/sse");this.buildSSE=new EventSource(e),this.buildSSE.addEventListener("message",(function(e){if(e.data){var n=JSON.parse(e.data);if(n.object){var i=n.object;console.log(i),i.pipeline_run&&t.$set(t.build,"pipeline_run",i.pipeline_run),i.stages_run&&t.$set(t.build,"stages_run",i.stages_run),-1==t.runningStatus.indexOf(t.build.pipeline_run.status)&&t.buildSSE.close();var a,s=Object(o["a"])(t.build.stages_run);try{for(s.s();!(a=s.n()).done;){var l=a.value;if(l.id==t.mainContent.mainStage.id){if(t.mainContent.mainStage=l,t.mainContent.mainJob.id){var r,u=Object(o["a"])(l.jobs);try{for(u.s();!(r=u.n()).done;){var d=r.value;d.id==t.mainContent.mainJob.id&&(t.mainContent.mainJob=d)}}catch(c){u.e(c)}finally{u.f()}}break}}}catch(c){s.e(c)}finally{s.f()}t.getJobLog()}}})),this.buildSSE.addEventListener("error",(function(t){t.readyState==EventSource.CLOSED&&console.log("event was closed")})),this.buildSSE.addEventListener("close",(function(e){console.log(e.type),t.buildSSE.close()}))},getBuildCommitId:function(){if(!this.build.pipeline_run)return"";if(!this.build.pipeline_run.env)return"";if(!this.build.pipeline_run.env["PIPELINE_CODE_COMMIT_ID"])return"";var t=this.build.pipeline_run.env["PIPELINE_CODE_COMMIT_ID"].substr(0,10),e=this.build.pipeline_run.env["PIPELINE_CODE_COMMIT_AUTHOR"];return t+" ("+e+")"},getBuildCommitComment:function(){return this.build.pipeline_run&&this.build.pipeline_run.env&&this.build.pipeline_run.env["PIPELINE_CODE_COMMIT_MESSAGE"]?this.build.pipeline_run.env["PIPELINE_CODE_COMMIT_MESSAGE"].substr(0,30):""},clickStage:function(t,e){this.mainContent.type=e?"job":"stage",this.mainContent.mainStage=t,this.mainContent.mainJob=e||{},this.getJobLog()},getJobLog:function(){var t=this;if("job"==this.mainContent.type)if(this.mainContent.mainJob.id!=this.jobLogId){this.mainContent.jobLog="",this.jobLogId=this.mainContent.mainJob.id,this.jobLogSSE&&this.jobLogSSE.close();var e=!1;this.runningStatus.indexOf(this.mainContent.mainJob.status)>=0&&(e=!0),e?this.fetchJobLogSSE(this.mainContent.mainJob.id):Object(l["c"])(this.mainContent.mainJob.id).then((function(e){t.$set(t.mainContent,"jobLog",e.data)})).catch((function(){}))}else-1==this.runningStatus.indexOf(this.mainContent.mainJob.status)&&this.jobLogSSE&&(this.jobLogSSE.close(),Object(l["c"])(this.mainContent.mainJob.id).then((function(e){t.$set(t.mainContent,"jobLog",e.data),t.$nextTick((function(){if(that.scrollToBottom){var t=document.getElementById("jobLogDiv");t.scrollTop=t.scrollHeight}}))})).catch((function(){})));else this.jobLogSSE&&this.jobLogSSE.close()},fetchJobLogSSE:function(t){var e=this,n="/api/v1/pipeline/build/log/".concat(t,"/sse");this.jobLogSSE=new EventSource(n),this.jobLogSSE.addEventListener("message",(function(t){if(t.data){e.$set(e.mainContent,"jobLog",t.data);var n=e;e.$nextTick((function(){if(n.scrollToBottom){var t=document.getElementById("jobLogDiv");t.scrollTop=t.scrollHeight}}))}})),this.jobLogSSE.addEventListener("error",(function(t){t.readyState==EventSource.CLOSED&&console.log("event was closed")})),this.jobLogSSE.addEventListener("close",(function(t){console.log(t.type),e.jobLogSSE.close()}))}}},u=r,d=(n("8713"),n("c85c"),n("2877")),c=Object(d["a"])(u,i,a,!1,null,"b529c3ae",null);e["default"]=c.exports},a77b:function(t,e,n){},c85c:function(t,e,n){"use strict";var i=n("a77b"),a=n.n(i);a.a}}]);