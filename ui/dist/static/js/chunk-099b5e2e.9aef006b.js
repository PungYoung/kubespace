(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-099b5e2e"],{"1bd0":function(e,t,i){"use strict";var a=i("84b3"),l=i.n(a);l.a},"1cb3":function(e,t,i){"use strict";i.d(t,"d",(function(){return l})),i.d(t,"b",(function(){return s})),i.d(t,"a",(function(){return n})),i.d(t,"c",(function(){return r}));i("99af");var a=i("b775");function l(e,t){return Object(a["a"])({url:"pipeline/build/list",method:"get",params:{pipeline_id:e,last_build_number:t}})}function s(e){return Object(a["a"])({url:"pipeline/build/".concat(e),method:"get"})}function n(e,t){return Object(a["a"])({url:"pipeline/build",method:"post",data:{pipeline_id:parseInt(e),params:t}})}function r(e,t){return Object(a["a"])({url:"pipeline/build/log/".concat(e).concat(t?"/sse":""),method:"get"})}},"2ad9":function(e,t,i){"use strict";i.d(t,"d",(function(){return l})),i.d(t,"c",(function(){return s})),i.d(t,"e",(function(){return n})),i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return c}));var a=i("b775");function l(e){return Object(a["a"])({url:"pipeline/pipeline",method:"get",params:{workspace_id:e}})}function s(e){return Object(a["a"])({url:"pipeline/pipeline/".concat(e),method:"get"})}function n(e){return Object(a["a"])({url:"pipeline/pipeline",method:"put",data:e})}function r(e){return Object(a["a"])({url:"pipeline/pipeline",method:"post",data:e})}function c(e){return Object(a["a"])({url:"pipeline/pipeline/".concat(e),method:"delete"})}},7631:function(e,t,i){"use strict";var a=i("79c6"),l=i.n(a);l.a},"79c6":function(e,t,i){},"84b3":function(e,t,i){},bd9f:function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[i("clusterbar",{attrs:{titleName:e.titleName,nameFunc:e.nameSearch,createDisplay:"构建",titleLink:["pipeline"]}},[i("el-button",{attrs:{slot:"right-btn",size:"small",type:"primary"},on:{click:e.openBuildParams},slot:"right-btn"},[i("i",{staticClass:"el-icon-video-play"}),e._v(" 构 建 ")])],1),i("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"dashboard-container dashboard-container-build",style:{"max-height":e.maxHeight+"px"},attrs:{"max-height":e.maxHeight}},[e._l(e.builds||[],(function(t){return i("div",{key:t.pipeline_run.id,staticClass:"build-list"},[i("div",{staticStyle:{"border-bottom":"1px solid #EBEEF5"}},[i("div",{staticClass:"build-info"},[i("div",{staticClass:"build-info__left",on:{click:function(i){return e.clickBuildDetail(t,"source")}}},[i("div",{staticClass:"build-info__left-number"},[i("div",{staticClass:"build-info__left-number-inner",style:{color:e.getBuildStatusColor(t.pipeline_run.status)}},["ok"==t.pipeline_run.status?[i("i",{staticClass:"el-icon-success"})]:e._e(),"error"==t.pipeline_run.status?[i("i",{staticClass:"el-icon-error"})]:e._e(),"wait"==t.pipeline_run.status?[i("i",{staticClass:"el-icon-remove"})]:e._e(),"doing"==t.pipeline_run.status?[i("i",{staticClass:"el-icon-refresh refresh-rotate"})]:e._e(),i("span",{staticClass:"build-info__left__number",on:{click:function(i){return e.clickBuildNumber(t)}}},[e._v(" #"+e._s(t.pipeline_run.build_number))])],2),i("div",{staticClass:"build-info__left-branch"},[i("svg-icon",{attrs:{"icon-class":"branch"}}),e._v(" "+e._s(t.pipeline_run.env.PIPELINE_CODE_BRANCH)+" ")],1)]),i("div",{staticClass:"build-info__left-op"},[i("div",{staticStyle:{height:"22px","line-height":"22px","vertical-align":"middle"}},[i("i",{staticClass:"el-icon-user"}),e._v(" "+e._s(t.pipeline_run.operator)+" ")]),i("div",{staticStyle:{"font-size":"12px","line-height":"22px",height:"22px","vertical-align":"middle"}},[i("i",{staticClass:"el-icon-date"}),e._v(" "+e._s(e.$dateFormat(t.pipeline_run.create_time))+" ")])])]),i("el-row",{staticStyle:{width:"100%"}},[i("el-steps",{staticClass:"el-steps",attrs:{simple:""}},e._l(t.stages_run,(function(a){return i("el-step",{key:a.id,attrs:{title:"",icon:"none",status:e.getStageStatus(a.status)}},[i("div",{staticClass:"el-steps-title",attrs:{slot:"title"},on:{click:function(i){return e.clickBuildDetail(t,"stage",a)}},slot:"title"},[i("div",{staticStyle:{"margin-left":"1px"}},[e._v(e._s(a.name))]),i("div",{staticStyle:{"margin-top":"3px"}},["ok"==a.status?[i("i",{staticClass:"el-icon-circle-check",staticStyle:{"font-size":"18px"}}),i("div",{staticClass:"el-steps-stage-exectime"},[e._v(" "+e._s(e.getStageExecTime(a.exec_time,a.update_time))+" ")])]:e._e(),"doing"==a.status?[i("i",{staticClass:"el-icon-refresh refresh-rotate",staticStyle:{"font-size":"18px"}}),i("div",{staticClass:"el-steps-stage-exectime"},[e._v(" "+e._s(e.getStageExecTimeStr(e.refreshStages[a.id]))+" ")])]:e._e(),"error"==a.status?[i("i",{staticClass:"el-icon-circle-close",staticStyle:{"font-size":"18px"}}),i("div",{staticClass:"el-steps-stage-exectime"},[e._v(" "+e._s(e.getStageExecTime(a.exec_time,a.update_time))+" ")])]:e._e(),"wait"==a.status?[i("i",{staticClass:"el-icon-remove-outline",staticStyle:{"font-size":"18px"}}),i("div",{staticClass:"el-steps-stage-exectime"},[e._v(" -- ")])]:e._e()],2)])])})),1)],1)],1),t.clickDetail?i("div",{staticClass:"build-detail",staticStyle:{"border-top":"1px solid #EBEEF5",padding:"10px 15px 15px"}},[t.clickDetail&&"source"==t.clickDetail.type?[i("div",{staticStyle:{"font-size":"14px",padding:"4px 3px 8px"}},[e._v(" 构建源 ")]),i("el-table",{staticStyle:{width:"100%"},attrs:{data:t.clickDetail&&t.clickDetail.commit||[],"cell-style":e.cellStyle}},[i("el-table-column",{attrs:{prop:"commitId",label:"CommitId",width:"330"}}),i("el-table-column",{attrs:{prop:"author",label:"Author",width:"100"}}),i("el-table-column",{attrs:{prop:"when",label:"When",width:"160"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.when?e.$dateFormat(t.row.when):"")+" ")]}}],null,!0)}),i("el-table-column",{attrs:{prop:"message",label:"Comment",width:""}})],1),i("el-button",{staticStyle:{"margin-top":"8px","border-radius":"0px",padding:"5px 15px"},attrs:{type:"primary",size:"mini"}},[e._v("重新构建")])]:e._e(),t.clickDetail&&"stage"==t.clickDetail.type?[i("div",{staticStyle:{"font-size":"14px",padding:"4px 3px 8px"}},[e._v(" 阶段："+e._s(t.clickDetail&&t.clickDetail.stage?t.clickDetail.stage.name:"")+" ")]),i("el-table",{staticStyle:{width:"100%"},attrs:{data:t.clickDetail&&t.clickDetail.stage?t.clickDetail.stage.jobs:[],"cell-style":e.cellStyle}},[i("el-table-column",{attrs:{prop:"name",label:"任务",width:"200"}}),i("el-table-column",{attrs:{prop:"result",label:"返回",width:""},scopedSlots:e._u([{key:"default",fn:function(t){return[i("span",[e._v(" "+e._s(t.row.result)+" ")])]}}],null,!0)})],1),i("el-button",{staticStyle:{"margin-top":"8px","border-radius":"0px",padding:"5px 15px"},attrs:{type:"primary",size:"mini"}},[e._v("重新构建")]),i("el-button",{staticStyle:{"margin-top":"8px","border-radius":"0px",padding:"5px 15px"},attrs:{type:"primary",size:"mini"}},[e._v("重新执行")])]:e._e()],2):e._e()])])})),e.loadMore?i("div",{staticStyle:{"text-align":"center",margin:"15px 15px 5px"}},[i("el-button",{staticStyle:{"border-radius":"0px"},attrs:{type:"primary",size:"small"},on:{click:e.fetchBuilds}},[e._v("加 载 更 多")])],1):e._e(),e.builds&&0==e.builds.length?i("div",{staticStyle:{"text-align":"center","margin-top":"30px","margin-left":"-100px",color:"#606266","font-size":"14px"}},[e._v(" 暂无流水线构建记录，"),i("span",{staticClass:"build-span",staticStyle:{color:"#409EFF"},on:{click:e.openBuildParams}},[e._v("执行流水线")])]):e._e()],2),i("el-dialog",{attrs:{title:"执行流水线",visible:e.dialogVisible,"destroy-on-close":!0,"close-on-click-modal":!1},on:{"update:visible":function(t){e.dialogVisible=t},close:function(t){e.buildParams={}}}},[i("div",{directives:[{name:"loading",rawName:"v-loading",value:e.dialogLoading,expression:"dialogLoading"}]},[i("div",{staticClass:"dialogContent",staticStyle:{padding:"0px 40px"}},[i("el-form",{ref:"",attrs:{model:e.buildParams,"label-position":"left","label-width":"105px"}},[i("el-form-item",{attrs:{label:"流水线",prop:"",required:!0}},[i("el-input",{staticStyle:{width:"250px"},attrs:{disabled:!0,placeholder:"",autocomplete:"off",size:"small"},model:{value:e.pipelineName,callback:function(t){e.pipelineName=t},expression:"pipelineName"}})],1),i("el-form-item",{attrs:{label:"构建分支",prop:"",required:!0}},[i("el-input",{staticStyle:{width:"250px"},attrs:{placeholder:"请输入构建分支",autocomplete:"off",size:"small"},model:{value:e.buildParams.branch,callback:function(t){e.$set(e.buildParams,"branch",t)},expression:"buildParams.branch"}})],1)],1)],1),i("div",{staticClass:"dialogFooter",staticStyle:{"margin-top":"20px"},attrs:{slot:"footer"},slot:"footer"},[i("el-button",{staticStyle:{"margin-right":"20px"},on:{click:function(t){e.dialogVisible=!1}}},[e._v("取 消")]),i("el-button",{attrs:{type:"primary"},on:{click:e.buildPipeline}},[e._v("确 定")])],1)])])],1)},l=[],s=(i("b0c0"),i("b85c")),n=i("61b2"),r=i("2ad9"),c=i("1cb3"),o=i("5c96"),p={name:"PipelineWorkspace",components:{Clusterbar:n["a"]},data:function(){return{titleName:[],search_name:"",users:[],cellStyle:{border:0,padding:"1px 0","line-height":"35px"},maxHeight:window.innerHeight-145,loading:!0,dialogVisible:!1,pipeline:{},pipelineName:"",builds:null,buildDetails:{},buildParams:{},pipelineSSE:null,refreshExecTimer:0,refreshStages:{},loadMore:!1,dialogLoading:!1}},created:function(){this.loading=!0,this.fetchPipeline(),this.fetchBuilds(),this.fetchPipelineSSE()},destroyed:function(){this.pipelineSSE.close(),this.refreshExecTimer&&clearTimeout(this.refreshExecTimer)},mounted:function(){var e=this;window.onresize=function(){return function(){var t=window.innerHeight-145;console.log(t),e.maxHeight=t}()}},computed:{pipelineId:function(){return this.$route.params.pipelineId}},methods:{fetchPipeline:function(){var e=this;Object(r["c"])(this.pipelineId).then((function(t){e.pipeline=t.data||{},e.pipeline&&(e.titleName=["流水线",e.pipeline.pipeline.name],e.pipelineName=e.pipeline.pipeline.name)})).catch((function(){}))},fetchBuilds:function(e){var t=this;this.loading=!0,void 0==e&&(e=0,this.builds&&this.builds.length>0&&(e=this.builds[this.builds.length-1].pipeline_run.build_number)),Object(c["d"])(this.pipelineId,e).then((function(i){t.loading=!1;var a=i.data||[];if(0==e)t.$set(t,"builds",a);else{var l,n=Object(s["a"])(a);try{for(n.s();!(l=n.n()).done;){var r=l.value;t.builds.push(r)}}catch(c){n.e(c)}finally{n.f()}}20==a.length?t.loadMore=!0:t.loadMore=!1,t.processExecTime()})).catch((function(){t.loading=!1}))},processExecTime:function(){var e,t=!1,i=Object(s["a"])(this.builds);try{for(i.s();!(e=i.n()).done;){var a,l=e.value,n=Object(s["a"])(l.stages_run);try{for(n.s();!(a=n.n()).done;){var r=a.value;if("doing"==l.pipeline_run.status)if("doing"==r.status){if(!this.refreshStages[r.id]){var c=new Date,o=new Date(r.exec_time);this.$set(this.refreshStages,r.id,Math.floor((c.getTime()-o.getTime())/1e3))}t=!0}else this.refreshStages[r.id]&&this.$delete(this.refreshStages,r.id);else this.refreshStages[r.id]&&this.$delete(this.refreshStages,r.id)}}catch(p){n.e(p)}finally{n.f()}}}catch(p){i.e(p)}finally{i.f()}!this.refreshExecTimer&&t?this.refreshExecTime():!t&&this.refreshExecTimer&&(clearTimeout(this.refreshExecTimer),this.refreshExecTimer=0)},refreshExecTime:function(){var e=this;this.refreshExecTimer&&(clearTimeout(this.refreshExecTimer),this.refreshExecTimer=0),this.refreshExecTimer=setTimeout((function(){var t=e.refreshStages;for(var i in t){var a=t[i];void 0!=a&&e.$set(e.refreshStages,i,a+1)}e.refreshExecTime()}),1e3)},fetchPipelineSSE:function(){var e=this,t="/api/v1/pipeline/pipeline/".concat(this.pipelineId,"/sse");this.pipelineSSE=new EventSource(t),this.pipelineSSE.addEventListener("message",(function(t){if(t.data){var i=JSON.parse(t.data);if(i.object){var a=i.object;for(var l in e.builds){var s=e.builds[l];if(s.pipeline_run.id==a.pipeline_run.id){e.$set(e.builds,l,a),e.processExecTime();break}}}}})),this.pipelineSSE.addEventListener("error",(function(e){e.readyState==EventSource.CLOSED&&console.log("event was closed")})),this.pipelineSSE.addEventListener("close",(function(t){console.log(t.type),e.pipelineSSE.close()}))},nameClick:function(e){this.$router.push({name:"pipelineBuilds",params:{pipelineId:e}})},nameSearch:function(e){this.search_name=e},openBuildParams:function(){this.dialogVisible=!0},buildPipeline:function(){var e=this;this.buildParams.branch?(this.dialogLoading=!0,Object(c["a"])(this.pipelineId,this.buildParams).then((function(t){e.$message({message:"构建成功",type:"success"}),e.dialogLoading=!1,e.fetchBuilds(0),e.dialogVisible=!1})).catch((function(t){e.dialogLoading=!1}))):o["Message"].error("请输入构建分支")},getStageStatus:function(e){return"ok"==e?"success":"error"==e?"error":"wait"==e?"wait":"doing"==e?"process":"cancel"==e?"wait":void 0},getBuildStatusColor:function(e){return"ok"==e?"#67c23a":"error"==e?"#DC143C":"doing"==e?"#E6A23C":""},getStageExecTime:function(e,t){if(t)i=new Date(t);else var i=new Date;var a=new Date(e),l=Math.floor((i.getTime()-a.getTime())/1e3);return this.getStageExecTimeStr(l)},getStageExecTimeStr:function(e){var t="",i=Math.floor(e/86400);i&&(t=i+"d");var a=e%86400,l=Math.floor(a/3600);l&&(t+=l+"h");var s=a%3600,n=Math.floor(s/60);n&&(t+=n+"m");var r=s%60,c=Math.round(r);return c&&(t+=c+"s"),t||(t="1s"),t},clickBuildDetail:function(e,t,i){var a=e.clickDetail;if(a){if("source"==t&&a.type==t)return void this.$set(e,"clickDetail",void 0);if("stage"==t&&a.stage&&a.stage.id==i.id)return void this.$set(e,"clickDetail",void 0)}if("source"==t){var l={commitId:e.pipeline_run.env.PIPELINE_CODE_COMMIT_ID,author:e.pipeline_run.env.PIPELINE_CODE_COMMIT_AUTHOR,message:e.pipeline_run.env.PIPELINE_CODE_COMMIT_MESSAGE,when:e.pipeline_run.env.PIPELINE_CODE_COMMIT_TIME};this.$set(e,"clickDetail",{type:t,commit:[l]})}else this.$set(e,"clickDetail",{type:t,stage:i})},clickBuildNumber:function(e){this.$router.push({name:"pipelineBuildDetail",params:{buildId:e.pipeline_run.id}})}}},u=p,d=(i("1bd0"),i("7631"),i("2877")),h=Object(d["a"])(u,a,l,!1,null,"0e8e2f25",null);t["default"]=h.exports}}]);